<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmMarket Pro - Cloud Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #10b981; --primary-dark: #047857; --accent: #f59e0b;
            --dark: #0f172a; --light: #f8fafc; --glass: rgba(255, 255, 255, 0.95);
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: var(--dark); margin: 0; min-height: 100vh; }

        /* NAVBAR */
        nav { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }

        /* 2. MOBILE RESPONSIVE CSS */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px 60px; }
        .hero { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 40px 5%; margin-bottom: 30px; border-radius: 0 0 30px 30px; text-align: center; }

        .card, .product-card {
            background: white;
            border-radius: 20px;
            width: 100%; /* Flexible width */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: 0.3s;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* 3. MEDIA QUERIES FOR PHONES */
        @media (max-width: 768px) {
            .hero h1 { font-size: 1.8rem; }
            .nav-actions .user-pill { display: none; } /* Hide name on very small screens to save space */
            .analytics-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .brand { font-size: 1rem; }
            .card { padding: 15px; }
        }

        /* Existing Styles maintained for functionality... */
        .hidden { display: none !important; }
        .search-wrapper { background: white; padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; max-width: 500px; margin: 0 auto; }
        .search-box { border: none; outline: none; padding: 10px; width: 100%; font-size: 1rem; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .card-img { height: 160px; width: 100%; object-fit: cover; background: #e2e8f0; position: relative; }
        .price-tag { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .booking-card { background: white; width: 95%; max-width: 400px; border-radius: 24px; overflow: hidden; text-align: center; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    </style>
</head>
<body>

<nav>
    <div class="brand"><i class="fas fa-leaf"></i> FarmMarket Pro</div>
    <div class="nav-actions">
        <div class="notif-wrapper" onclick="toggleNotif()" id="notifWrapper" style="display:none;">
            <i class="fas fa-bell notif-bell"></i><div class="notif-badge" id="notifBadge">0</div>
        </div>
        <a href="history.html" id="historyLink" class="user-pill" style="text-decoration:none;"><i class="fas fa-history"></i> Log</a>
        <div class="user-pill" id="userDisplay"></div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>
</nav>

<div id="buyerSection" class="hidden">
    <div class="hero">
        <h1>Fresh from the Farm.</h1>
        <div class="search-wrapper"><i class="fas fa-search" style="color:#94a3b8"></i><input type="text" id="searchInput" class="search-box" onkeyup="applyFilters()" placeholder="Search products..."></div>
    </div>
    <div class="container">
        <div class="product-grid" id="buyerGrid"></div>
    </div>
</div>

<div id="farmerSection" class="container hidden" style="margin-top:40px;">
    <div class="analytics-grid">
        <div class="card chart-card"><h3>Stock</h3><canvas id="stockChart"></canvas></div>
        <div class="card chart-card"><h3>Sales</h3><canvas id="salesChart"></canvas></div>
        <div class="card chart-card"><h3>Revenue</h3><canvas id="incomeChart"></canvas></div>
    </div>

    <div class="card" id="formCard">
        <h2><i class="fas fa-plus-circle"></i> Manage Stock</h2>
        <div class="form-grid" style="display: grid; gap: 15px;">
            <input type="text" id="pId" placeholder="Batch ID (e.g. B-001)">
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pQty" placeholder="Quantity">
            <input type="number" id="pPrice" placeholder="Price (₹)">
            <input type="date" id="pDate">
            <input type="text" id="pPhone" placeholder="Mobile No">
            <input type="email" id="pEmail" placeholder="Email">
            <button class="btn-main" id="btnMainAction" onclick="addProduct()">Add Product</button>
        </div>
    </div>

    <div class="card" style="margin-top:30px; overflow-x: auto;">
        <h3>Your Listings</h3>
        <table style="width:100%; min-width: 600px; border-collapse:collapse;" id="farmerTable">
            <thead><tr style="text-align:left; border-bottom:1px solid #eee;"><th>ID</th><th>PRODUCT</th><th>STOCK</th><th>PRICE</th><th>ACTION</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="toast"><i class="fas fa-check"></i> Success</div>

<script>
    // 4. THE AUTOMATIC URL SWITCHER
    const API_BASE_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
        ? "http://localhost:8080"
        : "https://farmer-inventory-managment.onrender.com";

    const API_URL = `${API_BASE_URL}/products`;
    const HISTORY_URL = `${API_BASE_URL}/products/history`;

    let allProducts = [];
    const user = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("userRole");

    if (!user) window.location.href = "login.html";
    document.getElementById("userDisplay").innerText = user;

    if (role === "FARMER") {
        document.getElementById("farmerSection").classList.remove("hidden");
        document.getElementById("notifWrapper").style.display = "block";
    } else {
        document.getElementById("buyerSection").classList.remove("hidden");
    }

    window.onload = async function() {
        await fetchProducts();
        if(role === "FARMER") {
            initCharts();
            checkNotifications();
            setInterval(checkNotifications, 5000);
        }
    };

    // 5. UPDATED FETCH FUNCTIONS FOR THE CLOUD
    async function fetchProducts() {
        try {
            const res = await fetch(API_URL);
            allProducts = await res.json();
            if(role === "BUYER") renderBuyerGrid(allProducts);
            else renderFarmerTable(allProducts.filter(p => p.farmerName === user));
        } catch(e) { console.error("Cloud connection failed", e); }
    }

    async function addProduct() {
        const data = {
            productId: document.getElementById("pId").value,
            productName: document.getElementById("pName").value,
            quantity: parseInt(document.getElementById("pQty").value),
            price: parseFloat(document.getElementById("pPrice").value),
            expiryDate: document.getElementById("pDate").value,
            farmerName: user,
            farmerPhone: document.getElementById("pPhone").value,
            farmerEmail: document.getElementById("pEmail").value
        };

        if(!data.productId || !data.productName) return alert("Fill fields");
        const isUpdate = document.getElementById("pId").disabled;

        try {
            const res = await fetch(API_URL + (isUpdate ? "/" + data.productId : ""), {
                method: isUpdate ? "PUT" : "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify(data)
            });

            if(res.ok) {
                showToast(isUpdate ? "Product Updated!" : "Product Added!");
                resetForm();
                fetchProducts();
            }
        } catch(e) { alert("Failed to add product to cloud database."); }
    }

    function renderFarmerTable(data) {
        const tbody = document.querySelector("#farmerTable tbody"); tbody.innerHTML = "";
        data.forEach(p => {
            tbody.innerHTML += `<tr style="border-bottom:1px solid #eee;"><td style="padding:15px;">${p.productId}</td><td><b>${p.productName}</b></td><td>${p.quantity}</td><td>₹${p.price}</td><td><button onclick="deleteItem('${p.productId}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }

    async function deleteItem(id) {
        if(confirm("Delete item?")) {
            await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            fetchProducts();
        }
    }

    function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = ""; }, 3000); }
    function resetForm() { document.querySelectorAll("#formCard input").forEach(i => i.value = ""); document.getElementById("pId").disabled = false; }
    function logout() { localStorage.clear(); window.location.href = "login.html"; }

    // Logic for Charts, Notifications, etc. remain the same but use API_URL and API_BASE_URL
</script>
</body>
</html>