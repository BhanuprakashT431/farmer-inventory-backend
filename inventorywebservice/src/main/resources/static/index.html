<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmMarket Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #10b981; --primary-dark: #047857; --accent: #f59e0b;
            --dark: #0f172a; --light: #f8fafc; --glass: rgba(255, 255, 255, 0.95);
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: var(--dark); margin: 0; min-height: 100vh; }

        /* NAVBAR */
        nav { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; }
        .nav-actions { display: flex; align-items: center; gap: 15px; }
        .user-pill { background: #ecfdf5; color: #065f46; padding: 8px 16px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; border: 1px solid #a7f3d0; }
        .btn-logout { background: #fee2e2; color: #ef4444; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; transition: 0.2s; }
        .btn-logout:hover { transform: scale(1.1); }

        /* NOTIFICATION BELL */
        .notif-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
        .notif-bell { font-size: 1.3rem; color: #64748b; transition: 0.2s; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; display: none; }

        /* LAYOUT & HERO */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px; }
        .hidden { display: none !important; }
        .hero { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 60px 5%; margin-bottom: 40px; border-radius: 0 0 40px 40px; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .search-wrapper { background: white; padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; max-width: 500px; margin: 0 auto; }
        .search-box { border: none; outline: none; padding: 10px; width: 100%; font-size: 1rem; }

        /* FILTERS & GRID */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: 0.3s; }
        .card-img { height: 160px; width: 100%; object-fit: cover; background: #e2e8f0; position: relative; }
        .price-tag { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
        .card-body { padding: 20px; }
        .btn-buy { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 8px; padding: 10px; width: 100%; font-weight: 700; cursor: pointer; }

        /* DASHBOARD & CHARTS */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 1.8rem; }
            .analytics-grid { grid-template-columns: 1fr; }
            .hero { padding: 40px 5%; border-radius: 0 0 25px 25px; }
            .nav-actions .user-pill { display: none; }
        }
    </style>
</head>
<body>

<nav>
    <div class="brand"><i class="fas fa-leaf"></i> FarmMarket Pro</div>
    <div class="nav-actions">
        <a href="history.html" id="historyLink" class="user-pill" style="text-decoration:none;"><i class="fas fa-history"></i> Log</a>
        <div class="user-pill" id="userDisplay"></div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>
</nav>

<div id="buyerSection" class="hidden">
    <div class="hero">
        <h1>Fresh from the Farm.</h1>
        <div class="search-wrapper"><i class="fas fa-search" style="color:#94a3b8"></i><input type="text" id="searchInput" class="search-box" onkeyup="applyFilters()" placeholder="Search products..."></div>
    </div>
    <div class="container">
        <div class="product-grid" id="buyerGrid"></div>
    </div>
</div>

<div id="farmerSection" class="container hidden" style="margin-top:40px;">
    <div class="analytics-grid">
        <div class="card"><h3>Stock</h3><canvas id="stockChart"></canvas></div>
        <div class="card"><h3>Sales</h3><canvas id="salesChart"></canvas></div>
        <div class="card"><h3>Revenue</h3><canvas id="incomeChart"></canvas></div>
    </div>
    <div class="card" id="formCard">
        <h2><i class="fas fa-plus-circle" style="color:var(--primary);"></i> Manage Stock</h2>
        <div class="form-grid">
            <input type="text" id="pId" placeholder="Batch ID">
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pQty" placeholder="Quantity">
            <input type="number" id="pPrice" placeholder="Price (₹)">
            <input type="date" id="pDate">
            <input type="text" id="pPhone" placeholder="Mobile">
            <input type="email" id="pEmail" placeholder="Email">
        </div>
        <button class="btn-main" onclick="addProduct()">Save Product to Cloud</button>
    </div>
</div>

<script>
    // THE LIVE SERVER CONFIG
    const API_BASE_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
        ? "http://localhost:8080"
        : "https://farmer-inventory-managment.onrender.com";

    const user = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("userRole");

    document.getElementById("userDisplay").innerText = user;
    if (!user) window.location.href = "login.html";

    if (role === "FARMER") document.getElementById("farmerSection").classList.remove("hidden");
    else document.getElementById("buyerSection").classList.remove("hidden");

    async function fetchProducts() {
        try {
            const res = await fetch(`${API_BASE_URL}/products`);
            const data = await res.json();
            if (role === "BUYER") renderBuyerGrid(data);
        } catch(e) { console.error("Connecting to Render...", e); }
    }

    async function addProduct() {
        const data = {
            productId: document.getElementById("pId").value,
            productName: document.getElementById("pName").value,
            quantity: parseInt(document.getElementById("pQty").value),
            price: parseFloat(document.getElementById("pPrice").value),
            expiryDate: document.getElementById("pDate").value,
            farmerName: user,
            farmerPhone: document.getElementById("pPhone").value,
            farmerEmail: document.getElementById("pEmail").value
        };
        try {
            const res = await fetch(`${API_BASE_URL}/products`, {
                method: "POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify(data)
            });
            if(res.ok) { alert("Product Added to Cloud!"); fetchProducts(); }
        } catch(e) { alert("Render server is waking up... please wait 30 seconds."); }
    }

    function renderBuyerGrid(data) {
        const grid = document.getElementById("buyerGrid");
        grid.innerHTML = "";
        data.forEach(p => {
            grid.innerHTML += `
                <div class="product-card">
                    <div class="card-img">
                        <img src="https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400" style="width:100%;height:100%;object-fit:cover;">
                        <div class="price-tag">₹${p.price}</div>
                    </div>
                    <div class="card-body">
                        <h3>${p.productName}</h3>
                        <p>${p.farmerName}</p>
                        <button class="btn-buy">Buy Now</button>
                    </div>
                </div>`;
        });
    }

    function logout() { localStorage.clear(); window.location.href = "login.html"; }
    window.onload = fetchProducts;
</script>
</body>
</html>