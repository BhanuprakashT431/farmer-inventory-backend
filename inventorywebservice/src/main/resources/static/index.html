<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmMarket Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #10b981; --primary-dark: #047857; --accent: #f59e0b;
            --dark: #0f172a; --light: #f8fafc; --glass: rgba(255, 255, 255, 0.95);
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: var(--dark); margin: 0; min-height: 100vh; }

        /* NAVBAR */
        nav { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; }
        .nav-actions { display: flex; align-items: center; gap: 15px; }
        .user-pill { background: #ecfdf5; color: #065f46; padding: 8px 16px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; border: 1px solid #a7f3d0; }
        .btn-logout { background: #fee2e2; color: #ef4444; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; transition: 0.2s; }
        .btn-logout:hover { transform: scale(1.1); }

        /* NOTIFICATION BELL */
        .notif-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
        .notif-bell { font-size: 1.3rem; color: #64748b; transition: 0.2s; }
        .notif-bell:hover { color: var(--primary); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; display: none; }

        .notif-dropdown { position: absolute; top: 60px; right: 80px; width: 300px; background: white; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: none; z-index: 1100; overflow: hidden; }
        .notif-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: 700; font-size: 0.9rem; display: flex; justify-content: space-between; }
        .notif-list { max-height: 300px; overflow-y: auto; }
        .notif-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-clear-notif { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem; }

        /* LAYOUT & HERO */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px; }
        .hidden { display: none !important; }
        .hero { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 60px 5%; margin-bottom: 40px; border-radius: 0 0 40px 40px; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .search-wrapper { background: white; padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; max-width: 500px; margin: 0 auto; }
        .search-box { border: none; outline: none; padding: 10px; width: 100%; font-size: 1rem; }

        /* FILTERS & GRID */
        .filters { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-chip { background: white; padding: 8px 20px; border-radius: 30px; cursor: pointer; border: 1px solid #e2e8f0; font-weight: 600; color: #64748b; transition: 0.2s; }
        .filter-chip:hover, .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: 0.3s; animation: fadeIn 0.5s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .card-img { height: 160px; width: 100%; object-fit: cover; background: #e2e8f0; position: relative; }
        .price-tag { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
        .card-body { padding: 20px; }
        .btn-buy { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 8px; padding: 10px; width: 100%; font-weight: 700; cursor: pointer; }
        .btn-contact { background: #eff6ff; color: #3b82f6; border: none; border-radius: 8px; padding: 10px; cursor: pointer; }

        /* FARMER DASHBOARD */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* CLICKABLE CHARTS */
        .chart-card { cursor: pointer; transition: transform 0.2s; position: relative; }
        .chart-card:hover { transform: translateY(-5px); border: 1px solid var(--primary); }
        .chart-card::after { content: "\f00e"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 20px; right: 20px; color: #ccc; opacity: 0; transition: 0.3s; }
        .chart-card:hover::after { opacity: 1; color: var(--primary); }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; transition: 0.2s; }
        .action-btn { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; }
        .btn-edit { background: #eff6ff; color: #3b82f6; }
        .btn-delete { background: #fef2f2; color: #ef4444; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .booking-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); text-align: center; animation: popUp 0.4s ease; }
        .booking-header { background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 30px 20px; color: white; }
        .booking-img-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; margin-top: -40px; background: white; object-fit: cover; }
        .qty-control { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; }
        .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; }
        .qty-input { width: 80px; text-align: center; font-size: 1.5rem; font-weight: 700; border: 2px solid #e2e8f0; border-radius: 10px; margin: 0; }

        .chart-modal-box { background: white; padding: 30px; width: 80%; max-width: 900px; height: 70vh; border-radius: 24px; position: relative; display: flex; flex-direction: column; }
        .btn-close-chart { position: absolute; top: 20px; right: 20px; background: #f3f4f6; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }

        @keyframes popUp { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<nav>
    <div class="brand"><i class="fas fa-leaf"></i> FarmMarket Pro</div>
    <div class="nav-actions">
        <div class="notif-wrapper" onclick="toggleNotif()" id="notifWrapper" style="display:none;">
            <i class="fas fa-bell notif-bell"></i><div class="notif-badge" id="notifBadge">0</div>
        </div>

        <a href="history.html" id="historyLink" class="user-pill" style="text-decoration:none;"><i class="fas fa-history"></i> Log</a>
        <div class="user-pill" id="userDisplay"></div>
        <button class="btn-logout" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>
</nav>

<div class="notif-dropdown" id="notifDropdown">
    <div class="notif-header"><span>Notifications</span><button class="btn-clear-notif" onclick="closeNotif()">Close</button></div>
    <div class="notif-list" id="notifList"></div>
</div>

<div id="buyerSection" class="hidden">
    <div class="hero">
        <h1>Fresh from the Farm.</h1>
        <p>Direct from local farmers to your table.</p>
        <div class="search-wrapper"><i class="fas fa-search" style="color:#94a3b8"></i><input type="text" id="searchInput" class="search-box" onkeyup="applyFilters()" placeholder="Search products..."></div>
    </div>
    <div class="container">
        <div class="filters">
            <div class="filter-chip active">All Products</div><div class="filter-chip">Vegetables</div><div class="filter-chip">Fruits</div><div class="filter-chip">Grains</div><div class="filter-chip">Organic</div>
        </div>
        <div class="product-grid" id="buyerGrid"></div>
    </div>
</div>

<div id="farmerSection" class="container hidden" style="margin-top:40px;">
    <div class="analytics-grid">
        <div class="card chart-card" onclick="openChartModal('stock')"><h3><i class="fas fa-cubes" style="color:var(--primary);"></i> Current Stock</h3><div style="height:220px"><canvas id="stockChart"></canvas></div></div>
        <div class="card chart-card" onclick="openChartModal('sales')"><h3><i class="fas fa-chart-pie" style="color:#3b82f6;"></i> Sales Volume</h3><div style="height:220px"><canvas id="salesChart"></canvas></div></div>
        <div class="card chart-card" onclick="openChartModal('income')"><h3><i class="fas fa-coins" style="color:#f59e0b;"></i> Revenue</h3><div style="height:220px"><canvas id="incomeChart"></canvas></div></div>
    </div>

    <div class="card" id="formCard">
        <h2 style="margin-top:0"><i class="fas fa-plus-circle" style="color:var(--primary);"></i> Manage Stock</h2>
        <div class="form-grid">
            <div class="input-group"><label>Batch ID</label><input type="text" id="pId" placeholder="B-001"></div>
            <div class="input-group"><label>Product Name</label><input type="text" id="pName" placeholder="e.g. Corn"></div>
            <div class="input-group"><label>Quantity</label><input type="number" id="pQty" placeholder="0"></div>
            <div class="input-group"><label>Price (₹)</label><input type="number" id="pPrice" placeholder="0.00"></div>
            <div class="input-group"><label>Expiry Date</label><input type="date" id="pDate"></div>
            <div class="input-group"><label>Phone</label><input type="text" id="pPhone" placeholder="Mobile No"></div>
            <div class="input-group"><label>Email</label><input type="email" id="pEmail" placeholder="Email"></div>
            <button class="btn-main" id="btnMainAction" onclick="addProduct()">Add Product</button>
        </div>
    </div>

    <div class="card" style="margin-top:30px;">
        <h3>Your Listings</h3>
        <table style="width:100%; border-collapse:collapse; margin-top:10px;" id="farmerTable">
            <thead><tr style="text-align:left; color:#64748b; font-size:0.85rem; border-bottom:1px solid #eee;"><th style="padding:10px;">ID</th><th>PRODUCT</th><th>STOCK</th><th>PRICE</th><th>EXPIRY</th><th>ACTION</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="buyModal" class="modal">
    <div class="booking-card">
        <div class="booking-header"><h2>Complete Order</h2><p>Buying Fresh Produce</p></div>
        <img id="buyImg" src="" class="booking-img-circle">
        <div style="padding:20px;">
            <h3 id="buyName" style="margin:10px 0 0;">Corn</h3><p id="buyFarmer" style="color:#64748b; font-size:0.9rem;">by Farmer</p>
            <div class="qty-control"><button class="qty-btn" onclick="updateQty(-1)">-</button><input type="number" id="buyQtyInput" class="qty-input" value="1" min="1" oninput="manualQtyInput()"><button class="qty-btn" onclick="updateQty(1)">+</button></div>
            <div style="font-size:1.5rem; font-weight:800; color:var(--primary); margin-bottom:15px;" id="buyTotalPrice">₹0</div>
            <button class="btn-main" style="margin:0;" onclick="confirmPurchase()">Confirm Booking</button>
            <button onclick="closeModal('buyModal')" style="background:none; border:none; color:#64748b; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal">
    <div class="booking-card" style="padding-bottom:20px;">
        <div style="background:#ecfdf5; padding:30px; color:#065f46;">
            <div style="background:white; width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; color:#10b981; font-size:2rem; box-shadow:0 5px 15px rgba(0,0,0,0.1);"><i class="fas fa-check"></i></div>
            <h2 style="margin:0;">Order Placed!</h2><p style="margin:0; opacity:0.8;">Thank you for shopping</p>
        </div>
        <div style="padding:20px;">
            <div style="background:#f8fafc; border:1px dashed #cbd5e1; padding:15px; border-radius:12px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Item</span><b id="tyItem">Corn</b></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Qty</span><b id="tyQty">10</b></div>
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; color:var(--primary); border-top:1px solid #e2e8f0; padding-top:8px;"><span>Total</span><b id="tyTotal">₹500</b></div>
            </div>
            <button class="btn-main" onclick="closeModal('successModal')">Continue Shopping</button>
        </div>
    </div>
</div>

<div id="contactModal" class="modal"><div class="booking-card"><div class="booking-header" style="background:#4f46e5;"><h2>Contact Seller</h2></div><div style="padding:30px;"><h3 id="cName">Name</h3><div style="background:#f8fafc; padding:15px; border-radius:10px; text-align:left; margin:15px 0;"><p><i class="fas fa-phone"></i> <span id="cPhone">--</span></p><p><i class="fas fa-envelope"></i> <span id="cEmail">--</span></p></div><button class="btn-main" onclick="closeModal('contactModal')">Close</button></div></div></div>
<div id="chartModal" class="modal"><div class="chart-modal-box"><button class="btn-close-chart" onclick="closeChartModal()"><i class="fas fa-times"></i></button><h2 id="modalChartTitle" style="margin-top:0;">Detailed View</h2><div style="flex-grow: 1; position: relative;"><canvas id="largeCanvas"></canvas></div></div></div>

<div id="toast"><i class="fas fa-check"></i> Success</div>

<script>
    const API_URL = "http://localhost:8080/products";
    const HISTORY_URL = "http://localhost:8080/products/history";
    let allProducts = [];
    let selectedProduct = null;
    let currentQty = 1;
    let currentCategory = 'All Products';

    let stockChart = null, salesChart = null, incomeChart = null, largeChartInstance = null;

    const user = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("userRole");

    if (!user) window.location.href = "login.html";
    document.getElementById("userDisplay").innerText = `${user}`;

    if (role === "FARMER") {
        document.getElementById("farmerSection").classList.remove("hidden");
        document.getElementById("notifWrapper").style.display = "block";
        setInterval(checkNotifications, 3000);
    } else {
        document.getElementById("buyerSection").classList.remove("hidden");
        document.getElementById("historyLink").style.display = "flex";
    }

    function logout() { localStorage.clear(); window.location.href = "login.html"; }

    window.onload = async function() {
        await fetchProducts();
        if(role === "FARMER") {
            await initCharts();
            checkNotifications();
        }
        setupFilters();
    };

    async function fetchProducts() {
        try {
            const res = await fetch(API_URL);
            allProducts = await res.json();
            if(role === "BUYER") applyFilters();
            else renderFarmerTable(allProducts.filter(p => p.farmerName === user));
        } catch(e) { console.error("Error fetching", e); }
    }

    // --- CHARTS (Revenue = PIE) ---
    async function initCharts() {
        try {
            const res = await fetch(`${HISTORY_URL}/farmer/${user}`);
            const history = await res.json();

            const sold = history.filter(t => t.type === 'SOLD');
            const labels = [...new Set(sold.map(t => t.productName))];

            const dataSales = labels.map(l => sold.filter(t => t.productName === l).reduce((a,b) => a+b.quantity, 0));
            const dataRev = labels.map(l => sold.filter(t => t.productName === l).reduce((a,b) => a+(b.quantity*b.price), 0));

            const myStock = allProducts.filter(p => p.farmerName === user);

            if(stockChart) stockChart.destroy(); if(salesChart) salesChart.destroy(); if(incomeChart) incomeChart.destroy();

            salesChart = new Chart(document.getElementById('salesChart'), {
                type:'doughnut',
                data: { labels: labels.length?labels:['None'], datasets:[{data:labels.length?dataSales:[1], backgroundColor:['#3b82f6','#f59e0b','#10b981','#ef4444']}] }
            });

            // REVENUE = PIE CHART
            incomeChart = new Chart(document.getElementById('incomeChart'), {
                type:'pie', // CHANGED TO PIE
                data: {
                    labels: labels.length?labels:['None'],
                    datasets:[{
                        label:'Revenue',
                        data:labels.length?dataRev:[0],
                        backgroundColor: ['rgba(255, 159, 64, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(153, 102, 255, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } }
                }
            });

            stockChart = new Chart(document.getElementById('stockChart'), {
                type:'bar',
                data: { labels:myStock.map(p=>p.productName), datasets:[{label:'Stock', data:myStock.map(p=>p.quantity), backgroundColor:'#10b981'}] }
            });
        } catch(e) { console.error("Chart Error", e); }
    }

    // --- BUYER (Sending Buyer Name Fix) ---
    async function confirmPurchase() {
        try {
            const res = await fetch(`${API_URL}/${selectedProduct.productId}/buy`, {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({
                    quantity: currentQty,
                    buyerName: user
                })
            });

            if(res.ok) {
                closeModal("buyModal");
                document.getElementById("tyItem").innerText = selectedProduct.productName;
                document.getElementById("tyQty").innerText = currentQty;
                document.getElementById("tyTotal").innerText = "₹" + (currentQty * selectedProduct.price);
                document.getElementById("successModal").style.display = "flex";

                selectedProduct.quantity -= currentQty;
                applyFilters();
            } else { alert("Error: " + await res.text()); }
        } catch(e) { console.error(e); }
    }

    // --- NOTIFICATIONS ---
    async function checkNotifications() { try { const res = await fetch(`${API_URL}/notifications/${user}`); if(res.ok) { const msgs = await res.json(); const badge = document.getElementById("notifBadge"); const list = document.getElementById("notifList"); list.innerHTML = ""; if(msgs.length > 0) { badge.style.display = "flex"; badge.innerText = msgs.length; msgs.forEach(m => { list.innerHTML += `<div class="notif-item"><div style="flex-grow:1">${m.message}</div><i class="fas fa-times" style="color:#ccc;cursor:pointer;" onclick="deleteNotif(${m.id})"></i></div>`; }); } else { badge.style.display = "none"; list.innerHTML = "<div style='padding:15px;text-align:center;color:#999'>No notifications</div>"; } } } catch(e) {} }
    async function deleteNotif(id) { await fetch(`${API_URL}/notifications/${id}`, { method: "DELETE" }); checkNotifications(); }
    function toggleNotif() { const d = document.getElementById("notifDropdown"); d.style.display = d.style.display === "block" ? "none" : "block"; }
    function closeNotif() { document.getElementById("notifDropdown").style.display = "none"; }

    // --- FARMER TABLE & EDIT ---
    function renderFarmerTable(data) {
        const tbody = document.querySelector("#farmerTable tbody"); tbody.innerHTML = "";
        data.forEach(p => {
            tbody.innerHTML += `<tr style="border-bottom:1px solid #eee;"><td style="padding:15px;">${p.productId}</td><td><b>${p.productName}</b></td><td>${p.quantity}</td><td>₹${p.price}</td><td>${p.expiryDate || '--'}</td><td><button onclick="editItem('${p.productId}')" class="action-btn btn-edit"><i class="fas fa-pen"></i></button><button onclick="deleteItem('${p.productId}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    function editItem(id) {
        const p = allProducts.find(x => x.productId === id); if(!p) return;
        document.getElementById("pId").value = p.productId; document.getElementById("pId").disabled = true;
        document.getElementById("pName").value = p.productName; document.getElementById("pQty").value = p.quantity;
        document.getElementById("pPrice").value = p.price; document.getElementById("pDate").value = p.expiryDate;
        document.getElementById("pPhone").value = p.farmerPhone || ""; document.getElementById("pEmail").value = p.farmerEmail || "";
        document.getElementById("btnMainAction").innerText = "Update Product"; document.getElementById("formCard").scrollIntoView({behavior:"smooth"});
    }
    async function addProduct() {
        const data = { productId: document.getElementById("pId").value, productName: document.getElementById("pName").value, quantity: parseInt(document.getElementById("pQty").value), price: parseFloat(document.getElementById("pPrice").value), expiryDate: document.getElementById("pDate").value, farmerName: user, farmerPhone: document.getElementById("pPhone").value, farmerEmail: document.getElementById("pEmail").value };
        if(!data.productId || !data.productName) return alert("Fill fields");
        const isUpdate = document.getElementById("pId").disabled;
        await fetch(API_URL + (isUpdate ? "/" + data.productId : ""), { method: isUpdate ? "PUT" : "POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) });
        showToast(isUpdate ? "Product Updated!" : "Product Added!");
        resetForm(); fetchProducts(); if(role === "FARMER") initCharts();
    }
    function resetForm() {
        document.getElementById("pId").value = ""; document.getElementById("pId").disabled = false;
        document.getElementById("pName").value = ""; document.getElementById("pQty").value = "";
        document.getElementById("pPrice").value = ""; document.getElementById("pDate").value = "";
        document.getElementById("pPhone").value = ""; document.getElementById("pEmail").value = "";
        document.getElementById("btnMainAction").innerText = "Add Product";
    }
    async function deleteItem(id) { if(confirm("Delete item?")) { await fetch(`${API_URL}/${id}`, {method:"DELETE"}); fetchProducts(); initCharts(); } }

    // --- UTILS & MODALS ---
    function openChartModal(type) {
        const modal = document.getElementById("chartModal"); const ctxLarge = document.getElementById("largeCanvas").getContext('2d');
        let sourceChart = (type === 'stock') ? stockChart : (type === 'sales') ? salesChart : incomeChart;
        if (!sourceChart) return; if (largeChartInstance) largeChartInstance.destroy();
        largeChartInstance = new Chart(ctxLarge, { type: sourceChart.config.type, data: sourceChart.config.data, options: { ...sourceChart.config.options, responsive: true, maintainAspectRatio: false } });
        modal.style.display = "flex";
    }
    function closeChartModal() { document.getElementById("chartModal").style.display = "none"; }
    function getImg(name) {
        const n = name.toLowerCase(); if(n.includes("corn")) return "https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400"; if(n.includes("wheat")) return "https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400"; if(n.includes("rice")) return "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400"; if(n.includes("tomato")) return "https://images.unsplash.com/photo-1592924357228-91a4daadcfea?w=400"; return "https://images.unsplash.com/photo-1495107334309-fcf20504a5ab?w=400";
    }
    function applyFilters() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allProducts.filter(p => p.productName.toLowerCase().includes(q));
        renderBuyerGrid(filtered);
    }
    function renderBuyerGrid(data) {
        const grid = document.getElementById("buyerGrid"); grid.innerHTML = "";
        data.forEach(p => {
            const isSold = p.quantity === 0;
            grid.innerHTML += `<div class="product-card"><div class="card-img"><img src="${getImg(p.productName)}" style="width:100%;height:100%;object-fit:cover;"><div class="price-tag">₹${p.price}/unit</div></div><div class="card-body"><div style="display:flex; justify-content:space-between; align-items:center;"><h3>${p.productName}</h3><span style="font-size:0.8rem;background:#ecfdf5;padding:2px 8px;border-radius:4px;">${p.quantity} Units</span></div><p style="color:#64748b; font-size:0.9rem"><i class="fas fa-user"></i> ${p.farmerName}</p><div style="display:grid; grid-template-columns:1fr 3fr; gap:10px; margin-top:15px;"><button class="btn-contact" onclick="showContact('${p.farmerName}','${p.farmerPhone}','${p.farmerEmail}')"><i class="fas fa-phone"></i></button>${isSold ? `<button disabled style="background:#e2e8f0; border:none; border-radius:8px; font-weight:600; color:#94a3b8;">Sold Out</button>` : `<button class="btn-buy" onclick="openBuyModal('${p.productId}')">Buy Now</button>`}</div></div></div>`;
        });
    }
    function openBuyModal(id) { selectedProduct = allProducts.find(p => p.productId === id); currentQty = 1; document.getElementById("buyName").innerText = selectedProduct.productName; document.getElementById("buyFarmer").innerText = "by " + (selectedProduct.farmerName || "Unknown"); document.getElementById("buyImg").src = getImg(selectedProduct.productName); document.getElementById("buyQtyInput").value = 1; updatePriceDisplay(); document.getElementById("buyModal").style.display = "flex"; }
    function updateQty(change) { let newQty = currentQty + change; if(newQty < 1) newQty = 1; if(newQty > selectedProduct.quantity) newQty = selectedProduct.quantity; currentQty = newQty; document.getElementById("buyQtyInput").value = currentQty; updatePriceDisplay(); }
    function manualQtyInput() { const val = parseInt(document.getElementById("buyQtyInput").value); if(!isNaN(val) && val > 0) { currentQty = val > selectedProduct.quantity ? selectedProduct.quantity : val; } else { currentQty = 1; } document.getElementById("buyQtyInput").value = currentQty; updatePriceDisplay(); }
    function updatePriceDisplay() { document.getElementById("buyTotalPrice").innerText = "₹" + (currentQty * selectedProduct.price).toFixed(2); }
    function showContact(name, phone, email) { document.getElementById("cName").innerText = name || "Farmer"; document.getElementById("cPhone").innerText = phone || "Not Provided"; document.getElementById("cEmail").innerText = email || "Not Provided"; document.getElementById("contactModal").style.display = "flex"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000); }
    function setupFilters() { document.querySelectorAll('.filter-chip').forEach(chip => { chip.addEventListener('click', () => { document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); chip.classList.add('active'); currentCategory = chip.innerText; applyFilters(); }); }); }
</script>
</body>
</html>